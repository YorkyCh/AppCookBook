{% extends 'base.html' %}
{% load widget_tweaks %}
{% block extra_head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
{{ block.super }}
{% endblock %}

{% block content %}
<div class="main-block" style="margin-top: 190px;">
  <h1>Edit Recipe</h1>
  <form method="post" enctype="multipart/form-data" action="{% url 'update_recipe' recipe.pk %}">
    {% csrf_token %}
    <div style="display: flex; align-items: center; margin-bottom: 10px;">
      <div>
        <div style="margin-bottom: 10px;">
            <div>{{ form.name.label_tag }}</div>
            <div style="margin-left: 15px">{{ form.name }}</div>
        </div>
        
        <div style="margin-bottom: 10px;">
          <div>{{ form.preparation_time.label_tag }}</div>
          <div style="margin-left: 15px">{{ form.preparation_time }}</div>
        </div>
          
        <div style="margin-bottom: 10px">
          <div>{{ form.spiciness.label_tag }}</div>
          <div style="margin-left: 15px">{{ form.spiciness }}</div>
        </div>
        <div style="margin-bottom: 50px">
          <h3>Categories:</h3>
          {% for checkbox in form.categories %}
            <div class="checkbox">
              <label>
                {{ checkbox.tag }}
                {{ checkbox.choice_label }}
              </label>
            </div>
          {% endfor %}
        </div>
      </div>

      <div>
        {% if recipe.image %}
        <img src="{{ recipe.image.url }}?{{ recipe.image.date_created|date:'U' }}" style="width: 530px; height: 300px; margin-left: 50px;" alt="Current Image">
        {% endif %}
        <div style="margin-left: 200px;">
          {{ form.image.label_tag }}
          <input type="file" name="{{ form.image.name }}" accept="image/*" id="{{ form.image.id_for_label }}">
          <label for="{{ form.image.id_for_label }}"></label>
        </div>
      </div>
    </div>

        

    <div style="display: flex; align-items: center; margin-bottom: 10px;">
        
        <div>
                <div style="margin-left: 10px;">
                  {{ form.description }}
                  <div style="margin-bottom: 10px;">
                    <div>{{ form.steps.label_tag }}</div>
                    <div style="margin-left: 15px">{{ form.steps }}</div>
                  </div>
                </div>
        </div>
    </div>

    <div>
      <label for="{{ form.portion_size.id_for_label }}">Portion Size:</label>
      <div>
        {{ form.portion_size }}
      </div>
    </div>


<div>
    <h3>Ingredients:</h3>
    {{ formset.management_form }}
    <div id="ingredients-container">
      {% for form in formset %}
      <div class="ingredient-input">
        {{ form.id }}
        <div class="ingredient-field">
          {{ form.ingredient.label_tag }} {{ form.ingredient }}
        </div>
        <div class="amount-field">
          {{ form.amount.label_tag }} {{ form.amount }}
        </div>
        <div class="unit-field">
          {{ form.unit|add_class:"ingredient-select" }}
        </div>
        <div class="remove-button">
          <button type="button" class="remove-ingredient-btn" style="
          background-color: #ff6f00;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
        ">Remove</button>
        </div>
      </div>
      {% endfor %}
    </div>
    
    <button type="button" id="add-ingredient-btn">Add Ingredient</button>
    

    <div style="justify-content: space-between;
    display: flex;
    width: 55%;
    margin-top: 10px">
    <button type="button" id="add-ingredient-btn" style="
    background-color: #ff6f00;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  ">Add Ingredient</button>
    <button type="submit" style="
    background-color: #ff6f00;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  ">Update Recipe</button>
    </div>


    {% if form_errors %}
  <ul>
    {% for error in form_errors %}
      <li>{{ error }}</li>
    {% endfor %}
  </ul>
{% endif %}

{% if formset_errors %}
  <ul>
    {% for error in formset_errors %}
      <li>{{ error }}</li>
    {% endfor %}
  </ul>
{% endif %}
</div>

</div>

<script>
$(document).ready(function() {
  var formCount = $('#id_ingredients-TOTAL_FORMS').val();
  var ingredientForm = $('#ingredients-container').children('.ingredient-input').first().clone();

  $('#add-ingredient-btn').click(function(e) {
    e.preventDefault();
    var newForm = ingredientForm.clone();
    newForm.find('input, select').each(function() {
      var name = $(this).attr('name').replace('-0-', '-' + formCount + '-');
      var id = 'id_' + name;
      $(this).attr({
        'name': name,
        'id': id
      }).val('').removeAttr('checked');
    });
    newForm.find('.remove-ingredient-btn').click(removeIngredient); // Add event listener to remove button
    $('#ingredients-container').append(newForm);
    formCount++;
    $('#id_ingredients-TOTAL_FORMS').val(formCount);

    // Initialize Select2 for the newly added ingredient fields
    newForm.find('.ingredient-select').select2({
      width: 'resolve'
    });
  });

  // Initialize Select2 for the initial ingredient fields
  $('.ingredient-select').select2({
    width: 'resolve'
  });

  // Event listener for remove button
  $('.remove-ingredient-btn').click(removeIngredient);

  // Function to remove ingredient form
  function removeIngredient() {
    var form = $(this).closest('.ingredient-input');
    form.remove();
    formCount--;
    $('#id_ingredients-TOTAL_FORMS').val(formCount);
  }
});

// Reinitialize Select2 after the formset is submitted
$(document).on('submit', 'form', function() {
  $('.ingredient-select').select2('destroy');
});
</script>
{% endblock %}